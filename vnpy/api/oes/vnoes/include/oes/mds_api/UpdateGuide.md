# MDS-API Update Guide    {#update_guide}

MDS_0.15.9 / 2019-05-31
-----------------------------------

### 1. API更新概要

  1. 服務端相容 v0.15.5.1 版本API, 客戶可以選擇不升級 (建議升級, 以相容深圳證券業務開關數量的調整)
  2. fix: 修復API無法支援取值大於1024的檔案描述符的問題
  3. 擴大深圳證券業務開關的最大數量, 以應對行情資料內容的更新
     - 該修改可能會對之前版本的API造成影響: 會影響到證券實時狀態訊息的延遲計算, 舊版本會讀取到無效的打點時間
  4. 調整行情資料型別(mdStreamType, eMdsMdStreamTypeT)的取值, 使其可以標識出快照行情的具體資料型別
     - 該修改會存在相容性問題, 客戶端程式可以通過編譯錯誤來識別需要調整的地方 (如果沒有編譯錯誤就不需要調整)
     - 行情資料型別的取值將盡量與訊息型別保持一致, 但以下型別比較特殊：
       - 深圳成交量統計指標
       - 上交所 Level1 行情快照-債券
       - 上交所 Level1 行情快照-基金
  5. 重新命名 securityType => mdProductType, 以避免與交易端的證券型別混淆
    - securityType => mdProductType
    - eMdsSecurityTypeT => eMdsMdProductTypeT
  6. 刪除已經廢棄的虛擬集合競價訊息的訊息定義和資料型別定義
  7. API新增如下介面
     | API                          | 描述
     | ---------------------------- | ---------------
     | MdsApi_QueryStockStaticInfo  | 查詢證券(股票/債券/基金)靜態資訊
     | MdsApi_QuerySnapshotList     | 批量查詢行情快照介面
     | MdsApi_InitAllByCfgStruct    | 按照配置資訊結構體初始化客戶端環境介面
     | MdsApi_SendChangePasswordReq | 修改客戶端登入密碼
     | MdsApi_SetCustomizedIp       | 設定客戶端自定義的本地IP地址
     | MdsApi_GetCustomizedIp       | 獲取客戶端自定義的本地IP
     | MdsApi_SetCustomizedMac      | 設定客戶端自定義的本地MAC地址
     | MdsApi_GetCustomizedMac      | 獲取客戶端自定義的本地MAC
     | MdsApi_SetCustomizedDriverId | 設定客戶端自定義的本地裝置序列號
     | MdsApi_GetCustomizedDriverId | 獲取客戶端自定義的本地裝置序列號
  8. 新增錯誤碼1029、1034、1035、1036, 調整錯誤碼1007、1022的描述資訊
     | 錯誤碼 | 描述
     | ---- | ---------------
     | 1007 | 非服務開放時間
     | 1022 | 尚不支援或尚未開通此業務
     | 1029 | 密碼未改變
     | 1034 | 密碼強度不足
     | 1035 | 非法的產品型別
     | 1036 | 未通過黑白名單檢查

### 2. 服務端更新概要

  1. fix: 修復上海L2快照初始的最低價沒有被設定的問題
  2. fix: 解決 MdsApi_SubscribeByString 介面的字串快取太小, 最多隻能訂閱14000只證券的問題
  3. fix: 取消不必要的期權行情降噪處理, 以修復期權行情數量相對較少的問題（35%）
  4. fix: 修復在追加訂閱行情時, 會把全市場訂閱標誌沖掉的問題
  5. fix: 修復市場總覽行情中交易所傳送時間為負數的問題
  6. 完善單條行情快照查詢, 允許對交易所程式碼和行情資料進行模糊匹配(不必再明確指定交易所程式碼);
     並且當不存在L1快照時將嘗試檢索L2快照, 而查詢結果統一轉換為五檔快照返回
  7. 調整L2逐筆資料的行情組播頻道, 按照頻道號混合推送逐筆成交和逐筆委託, 取代之前逐筆成交/逐筆委託分別推送的方式(API保持相容, 但頻道的內容發生了變化)
  8. 優化快照行情的去重處理
  9. 修復其他系統缺陷, 完善安全機制

### 3. 注意事項說明

  1. 以下兩處重構可能會引起編譯錯誤, 這兩個欄位通常不會使用, 可以通過編譯錯誤來識別是否有需要調整的地方, 如果沒有編譯錯誤就不需要調整
     - 重新命名 securityType => mdProductType
     - 調整行情資料型別(mdStreamType, eMdsMdStreamTypeT)的取值
  2. 伺服器端對L2逐筆資料的行情組播頻道做了調整, 將按照頻道號混合推送逐筆成交和逐筆委託, 以保留逐筆委託和逐筆成交之間時序關係
     - 之前的逐筆成交/逐筆委託是通過兩個頻道分別推送的, 需要留意調整以後對處理邏輯是否有影響
  3. 伺服器端對快照行情的去重處理進行了優化
     - 當以 tickType=0 的模式訂閱行情時, 伺服器端會對重複的快照行情做去重處理, 不會再推送重複的資料
     - 如果需要獲取到所有時點的快照, 可以使用 tickType=1 的模式訂閱行情。該模式會和之前版本的行為保持一致, 只要行情時間有變化, 即使資料重複也會對下游推送


---

MDS_0.15.7.4 / 2018-08-31
-----------------------------------

### 1. API更新概要

  1. 服務端相容 v0.15.5.1 版本API，客戶可以選擇不升級 (建議升級)
  2. fix: 修復當多個執行緒同時初始化API日誌時, 會導致日誌資訊重複輸出的問題
  3. API新增如下介面
    | API                          | 描述
    | ---------------------------- | ---------------
    | MdsApi_SetLastError          | 設定當前執行緒的API錯誤號
    | MdsApi_GetLastError          | 獲取當前執行緒最近一次API呼叫失敗的錯誤號
    | MdsApi_HasMoreCachedData     | 獲取回報通道中尚未被回撥函式處理的快取資料長度
    | MdsApi_SetThreadUsername     | 設定當前執行緒的登入使用者名稱
    | MdsApi_SetThreadPassword     | 設定當前執行緒的登入密碼
  4. 新增部分錯誤碼
    | 錯誤碼 | 描述
    | ---- | ---------------
    | 1031 | 非法的加密型別
    | 1033 | 無可用節點
  5. 重構 SubscribeByString 介面, 增強行情訂閱的靈活性
  6. 增加可訂閱的資料種類 (DataType), 以支援單獨訂閱指數行情和期權行情
  7. 增加可以處理壓縮過的訊息的 MdsApi_WaitOnMsgCompressible 介面, 以支援對接壓縮後的行情資料

### 2. 服務端更新概要

  1. fix: 修復上海L2增量快照中最低價沒有正確更新(長時間為0)的BUG
  2. fix: 修復行情訂閱列表的計數器缺陷（把相同的證券程式碼分別作為指數程式碼和股票程式碼指定了兩遍時，會訂閱不到指數行情的問題）
  3. fix: 修復沒有攔截掉9:25前後已經過時的虛擬集合競價訊息的問題
  4. 修復其他系統缺陷，完善管理功能和故障恢復處理


---

MDS_0.15.5.16 / 2018-08-31
-----------------------------------

### 1. API更新概要

  1. 服務端相容 v0.15.5.1 版本API, 客戶可以選擇不升級 (建議升級)
  2. fix: 修復當多個執行緒同時初始化API日誌時, 會導致日誌資訊重複輸出的問題
  3. 增加 MdsApi_HasMoreCachedData 介面, 用於返回已經接收到但尚未被回撥函式處理的快取資料長度
  4. 增加 MdsApi_GetLastError 介面, 用於返回最近一次API呼叫失敗的錯誤號
  5. 增加設定當前執行緒登入使用者名稱/登入密碼的介面
  6. 重構 SubscribeByString 介面, 增強行情訂閱的靈活性
  7. 增加可訂閱的資料種類 (DataType), 以支援單獨訂閱指數行情和期權行情
  8. 增加可以處理壓縮過的訊息的 MdsApi_WaitOnMsgCompressible 介面, 以支援對接壓縮後的行情資料

### 2. 服務端更新概要

  1. fix: 修復上海L2增量快照中最低價沒有正確更新(長時間為0)的BUG
  2. fix: 修復行情訂閱列表的計數器缺陷（把相同的證券程式碼分別作為指數程式碼和股票程式碼指定了兩遍時, 會訂閱不到指數行情的問題）
  3. fix: 修復沒有攔截掉9:25前後已經過時的虛擬集合競價訊息的問題
  4. 修復系統缺陷, 完善管理功能和故障恢復處理


---

MDS_0.15.5.11 / 2018-06-20
-----------------------------------

### 1. API更新概要

  1. 服務端相容 v0.15.5.1 版本API, 客戶可以選擇不升級 (建議升級)
  2. fix: 擴大Level2增量更新訊息支援的最大價位變更數量和委託明細數量, 修復在巨幅波動場景下會因為支援的價位數量不足導致丟失價位資訊的BUG 
     - 如果使用的是舊版本的API, 那麼伺服器端將不再推送增量更新訊息 (只推送全量快照), 以此來保持相容
     - 如果需要使用增量更新訊息的話, 就需要更新到最新版本的API, 否則不需要更新API
  3. 行情訂閱條件和訂閱配置中增加 '逐筆資料的過期時間型別 tickExpireType' (相容之前版本)

### 2. 服務端更新概要

  1. fix: 修復因行情釋出服務和轉發服務使用了相同的請求佇列, 導致偶發行情訂閱請求無法被正確處理的BUG
  2. fix: 修復在行情巨幅波動場景下因為支援的增量更新價位數量不足導致丟失價位資訊的BUG
  3. fix: 修正上海L2（增量）快照會出現最新價不在最低價和最高價之間的問題
  4. fix: 避免因為把相同的證券程式碼分別作為指數程式碼和股票程式碼指定了兩遍, 導致指數的已訂閱數量為0, 進而不推送指數行情的問題
  5. 新增面向低速網路的行情轉發服務
  6. 優化深證行情的轉發處理, 改善早盤高峰時期行情延遲過大的問題


---

MDS_0.15.5.4 / 2018-02-22
-----------------------------------

### 1. API更新概要

  1. 服務端相容 v0.15.5.1 版本API, 客戶可以選擇不升級
  2. fix: 解決在Windows下的相容性問題
  3. 調整介面 MdsApi_InitAll, 增加一個函式引數 (pUdpTickOrderAddrKey), 以支援分別訂閱逐筆成交和逐筆委託的行情組播
     - 因為增加了介面引數, 需要對程式進行修改, 對該引數傳 NULL 即可
  4. 增加介面 MdsApi_GetLastRecvTime、MdsApi_GetLastSendTime, 用於獲取通道最近接受/傳送訊息的時間
  5. 登入失敗時, 可以通過 errno/SPK_GET_ERRNO() 獲取到具體失敗原因

### 2. 服務端更新概要

  1. fix: 優化行情推送, 改善推送服務的公平性
  2. fix: 修復在計算深圳逐筆成交的成交金額時沒有轉換為int64, 導致溢位的BUG
  3. fix: 修復上海L1指數快照的 securityType 不正確, 取值都是 1 的BUG
  4. fix: 修復查詢L1快照時, 未按照查詢條件 securityType 進行匹配的問題
  5. fix: 修復 mds_tester 查詢功能無法使用的問題
  6. 支援指定行情組播發送端的埠號
  7. 優化深證行情采集, 改善早盤高峰時期行情延遲過大的問題
  8. 優化行情組播的傳送延遲
